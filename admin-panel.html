<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TattooNOW Comments – Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0a0a0a;
      --bg-card: #1a1a1a;
      --bg-input: #252525;
      --text: #fafafa;
      --text-muted: #999;
      --border: #333;
      --accent: #EA9320;
      --green: #4ade80;
      --red: #f87171;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Roboto', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 24px;
    }

    .admin-header {
      max-width: 900px;
      margin: 0 auto 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .admin-header h1 {
      font-family: 'Roboto Slab', serif;
      font-size: 1.5rem;
      font-weight: 700;
    }

    .admin-header h1 span { color: var(--accent); }

    .config-bar {
      max-width: 900px;
      margin: 0 auto 24px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px 20px;
      display: flex;
      gap: 12px;
      align-items: end;
      flex-wrap: wrap;
    }

    .config-bar .field { flex: 1; min-width: 200px; }
    .config-bar label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
    .config-bar input { width: 100%; padding: 8px 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.85rem; font-family: 'Roboto', sans-serif; }
    .config-bar input:focus { outline: none; border-color: var(--accent); }

    .config-bar button {
      padding: 8px 20px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 6px;
      font-family: 'Roboto Slab', serif;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.85rem;
      white-space: nowrap;
    }

    .config-bar button:hover { opacity: 0.9; }

    /* Tabs */
    .tabs {
      max-width: 900px;
      margin: 0 auto 16px;
      display: flex;
      gap: 4px;
    }

    .tab {
      padding: 8px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px 8px 0 0;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.2s;
      border-bottom: none;
    }

    .tab.active {
      background: var(--bg-card);
      color: var(--accent);
      border-color: var(--accent);
      border-bottom: 2px solid var(--bg-card);
      margin-bottom: -1px;
      position: relative;
      z-index: 1;
    }

    .tab .badge {
      background: var(--accent);
      color: #fff;
      font-size: 0.7rem;
      padding: 1px 7px;
      border-radius: 10px;
      margin-left: 6px;
    }

    /* Comment cards */
    .comments-list {
      max-width: 900px;
      margin: 0 auto;
    }

    .comment-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 10px;
      transition: border-color 0.2s;
    }

    .comment-card:hover { border-color: var(--accent)66; }

    .comment-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
      gap: 12px;
    }

    .comment-meta { flex: 1; }

    .comment-author {
      font-family: 'Roboto Slab', serif;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .comment-email {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .comment-slug {
      font-size: 0.75rem;
      color: var(--accent);
      margin-top: 2px;
    }

    .comment-time {
      font-size: 0.75rem;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .comment-body {
      font-size: 0.9rem;
      line-height: 1.6;
      color: var(--text)dd;
      margin: 12px 0;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .comment-actions {
      display: flex;
      gap: 8px;
    }

    .btn-approve, .btn-reject, .btn-spam {
      padding: 6px 14px;
      border: 1px solid;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      background: transparent;
      transition: all 0.2s;
    }

    .btn-approve { color: var(--green); border-color: var(--green); }
    .btn-approve:hover { background: var(--green); color: var(--bg); }
    .btn-reject { color: var(--red); border-color: var(--red); }
    .btn-reject:hover { background: var(--red); color: var(--bg); }
    .btn-spam { color: var(--text-muted); border-color: var(--border); }
    .btn-spam:hover { background: var(--border); color: var(--text); }

    .empty-state {
      text-align: center;
      padding: 48px;
      color: var(--text-muted);
    }

    .status-badge {
      display: inline-block;
      font-size: 0.7rem;
      font-weight: 500;
      padding: 2px 8px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-left: 8px;
    }

    .status-badge.approved { color: var(--green); background: #0d3320; }
    .status-badge.rejected { color: var(--red); background: #3b1111; }
    .status-badge.spam { color: var(--text-muted); background: #2a2a2a; }
    .status-badge.pending { color: var(--accent); background: #EA932033; }
  </style>
</head>
<body>

  <div class="admin-header">
    <h1><span>●</span> Comment Moderation</h1>
  </div>

  <div class="config-bar">
    <div class="field">
      <label>Supabase Edge Function URL</label>
      <input type="text" id="cfg-url" placeholder="https://xxx.supabase.co/functions/v1/comments" />
    </div>
    <div class="field">
      <label>Admin API Key</label>
      <input type="password" id="cfg-key" placeholder="Your COMMENTS_ADMIN_KEY" />
    </div>
    <button onclick="loadComments()">Connect</button>
  </div>

  <div class="tabs" id="tabs">
    <div class="tab active" data-status="pending" onclick="switchTab('pending')">Pending <span class="badge" id="badge-pending">0</span></div>
    <div class="tab" data-status="approved" onclick="switchTab('approved')">Approved</div>
    <div class="tab" data-status="rejected" onclick="switchTab('rejected')">Rejected</div>
    <div class="tab" data-status="spam" onclick="switchTab('spam')">Spam</div>
  </div>

  <div class="comments-list" id="comments-list">
    <div class="empty-state">Enter your Supabase function URL and admin key above to connect.</div>
  </div>

  <script>
    let allComments = [];
    let currentTab = 'pending';

    function getConfig() {
      return {
        url: document.getElementById('cfg-url').value.trim(),
        key: document.getElementById('cfg-key').value.trim(),
      };
    }

    // Save/restore config from localStorage
    (function restoreConfig() {
      try {
        const saved = localStorage.getItem('tnow_admin_config');
        if (saved) {
          const cfg = JSON.parse(saved);
          document.getElementById('cfg-url').value = cfg.url || '';
          document.getElementById('cfg-key').value = cfg.key || '';
        }
      } catch(e) {}
    })();

    function saveConfig() {
      const cfg = getConfig();
      try { localStorage.setItem('tnow_admin_config', JSON.stringify(cfg)); } catch(e) {}
    }

    async function loadComments() {
      const cfg = getConfig();
      if (!cfg.url || !cfg.key) { alert('Please enter URL and API key'); return; }
      saveConfig();

      try {
        const res = await fetch(`${cfg.url}?admin=true`, {
          headers: {
            'Authorization': `Bearer ${cfg.key}`,
            'Content-Type': 'application/json',
          },
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || `Failed to load comments (${res.status})`);
        }

        const data = await res.json();
        allComments = data.comments || [];
        renderTab();
      } catch (err) {
        document.getElementById('comments-list').innerHTML =
          `<div class="empty-state">Error: ${err.message}</div>`;
      }
    }

    function switchTab(status) {
      currentTab = status;
      document.querySelectorAll('.tab').forEach(t => {
        t.classList.toggle('active', t.dataset.status === status);
      });
      renderTab();
    }

    function renderTab() {
      const list = document.getElementById('comments-list');
      const filtered = allComments.filter(c => c.status === currentTab);

      // Update pending badge
      const pendingCount = allComments.filter(c => c.status === 'pending').length;
      document.getElementById('badge-pending').textContent = pendingCount;

      if (filtered.length === 0) {
        list.innerHTML = `<div class="empty-state">No ${currentTab} comments.</div>`;
        return;
      }

      list.innerHTML = filtered.map(c => `
        <div class="comment-card" id="card-${c.id}">
          <div class="comment-top">
            <div class="comment-meta">
              <span class="comment-author">${esc(c.author_name)}</span>
              <span class="status-badge ${c.status}">${c.status}</span>
              <div class="comment-email">${esc(c.author_email)}</div>
              <div class="comment-slug">${esc(c.location_id)} · ${esc(c.blog_slug)}</div>
            </div>
            <span class="comment-time">${new Date(c.created_at).toLocaleString()}</span>
          </div>
          <div class="comment-body">${esc(c.comment_text)}</div>
          <div class="comment-actions">
            ${c.status !== 'approved' ? `<button class="btn-approve" onclick="moderate('${c.id}', 'approve')">✓ Approve</button>` : ''}
            ${c.status !== 'rejected' ? `<button class="btn-reject" onclick="moderate('${c.id}', 'reject')">✕ Reject</button>` : ''}
            ${c.status !== 'spam' ? `<button class="btn-spam" onclick="moderate('${c.id}', 'spam')">⚑ Spam</button>` : ''}
          </div>
        </div>
      `).join('');
    }

    async function moderate(commentId, action) {
      const cfg = getConfig();
      try {
        const res = await fetch(cfg.url, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${cfg.key}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            comment_id: commentId,
            action: action,
            reviewed_by: 'admin',
          }),
        });

        if (!res.ok) throw new Error('Action failed');

        // Update local state
        const comment = allComments.find(c => c.id === commentId);
        if (comment) {
          const statusMap = { approve: 'approved', reject: 'rejected', spam: 'spam' };
          comment.status = statusMap[action];
        }
        renderTab();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    function esc(str) {
      const div = document.createElement('div');
      div.textContent = str || '';
      return div.innerHTML;
    }
  </script>
</body>
</html>
